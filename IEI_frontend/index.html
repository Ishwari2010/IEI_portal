<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IEI SMS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --primary:#1f3c88;
  --primary-dark:#162f6a;
  --bg:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}
*{box-sizing:border-box;font-family:Inter,system-ui;}
body{
  margin:0;min-height:100vh;background:var(--bg);
  padding:40px 16px;color:#1f2937;
}
.container{max-width:1200px;margin:auto;}
.header{text-align:center;color:white;margin-bottom:30px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
@media(max-width:900px){.grid{grid-template-columns:1fr;}}
.card{
  background:white;border-radius:16px;padding:24px;
  box-shadow:0 18px 35px rgba(0,0,0,.18);
}
h2{color:var(--primary);margin-bottom:6px;}
p{color:#6b7280;font-size:.85rem;margin-bottom:18px;}
label{
  display:block;font-size:.7rem;font-weight:700;
  margin-bottom:6px;letter-spacing:.04em;
}
input,select,textarea{
  width:100%;padding:10px 12px;border-radius:10px;
  border:1px solid #d1d5db;font-size:.9rem;
}
button{
  width:100%;padding:12px;border-radius:999px;
  border:none;background:var(--primary);
  color:white;font-weight:600;cursor:pointer;
}
button:hover{background:var(--primary-dark);}
.divider{height:1px;background:#e5e7eb;margin:20px 0;}
.status{margin-top:8px;font-size:.85rem;color:#0369a1;}
.logs{
  margin-top:30px;background:white;border-radius:16px;
  padding:22px;box-shadow:0 18px 35px rgba(0,0,0,.18);
}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;}
th{background:#f9fafb;}
.tag{padding:4px 10px;border-radius:999px;background:#e0f2fe;color:#0369a1;font-size:.7rem;}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h1>IEI SMS Management System</h1>
  <p>Password dispatch & bulk messaging platform</p>
</div>

<div class="grid">

<!-- USER -->
<div class="card">
  <h2>User – Request Password</h2>
  <p>Receive IEI portal password via SMS</p>

  <label>Membership Type</label>
  <select id="prefix">
    <option value="F-">F</option>
    <option value="M-">M</option>
    <option value="AM">AM</option>
    <option value="ST">ST</option>
    <option value="T-">T</option>
  </select>

  <label>Membership Number</label>
  <input id="number" maxlength="7" placeholder="7-digit number">

  <button onclick="sendSingle()">Send Password</button>
</div>

<!-- ADMIN -->
<div class="card">
  <h2>Admin – Upload Excel</h2>
  <p>Upload members for bulk SMS</p>

  <input type="file" id="excelFile" accept=".xls,.xlsx">
  <button onclick="uploadExcel()">Upload Excel</button>
  <div id="uploadStatus" class="status"></div>

  <div class="divider"></div>

  <h2 style="font-size:1rem">Bulk SMS Controls</h2>

  <label>Batch Size</label>
  <input id="batchSize" type="number" value="5">

  <label>Delay (ms)</label>
  <input id="delayMs" type="number" value="3000">

  <label>Start Index</label>
  <input id="startIndex" type="number" value="0">

  <label>Limit (optional)</label>
  <input id="limit" type="number" placeholder="All">

  <button onclick="startBulk()">Start Bulk SMS</button>
  <div id="bulkStatus" class="status">Idle</div>

  <div class="divider"></div>

  <h2 style="font-size:1rem">Manual SMS</h2>

  <label>Phone Numbers</label>
  <textarea id="manualNumbers" rows="4" placeholder="One number per line"></textarea>

  <label>Message</label>
  <textarea id="manualMessage" rows="3" placeholder="Enter SMS text"></textarea>

  <button onclick="sendManual()">Send Manual SMS</button>
</div>

</div>

<!-- LOGS -->
<div class="logs">
  <h2>Sent Messages Report</h2>
  <div id="logs">No messages sent yet.</div>
</div>

</div>

<script>
async function fetchLogs(){
  const r = await fetch("/sent-logs");
  const d = await r.json();

  if (!d.length) {
    logs.innerHTML = "No messages sent yet.";
    return;
  }

  let h = `
    <table>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Date & Time</th>
        <th>Status</th>
      </tr>`;

  d.forEach(x => {
    h += `
      <tr>
        <td>${x.membership_id}</td>
        <td>${x.name || "-"}</td>
        <td>${x.email || "-"}</td>
        <td>******${x.last4}</td>
        <td>${new Date(x.timestamp).toLocaleString()}</td>
        <td><span class="tag">${x.status}</span></td>
      </tr>`;
  });

  logs.innerHTML = h + "</table>";
}


async function sendSingle(){
  if(!/^\d{7}$/.test(number.value))return;
  await fetch("/send-password",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({membership_id:prefix.value+number.value})});
  fetchLogs();
}

async function uploadExcel(){
  const file=excelFile.files[0];
  if(!file){uploadStatus.textContent="Please select a file";return;}
  const fd=new FormData();
  fd.append("file",file);
  const r=await fetch("/upload-excel",{method:"POST",body:fd});
  const d=await r.json();
  uploadStatus.textContent=`${d.message} (${d.totalMembers} members)`;
  fetchLogs();
}

async function startBulk(){
  bulkStatus.textContent="Running...";
  await fetch("/bulk-send",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    batchSize:+batchSize.value,
    delayMs:+delayMs.value,
    start:+startIndex.value,
    limit:limit.value||undefined
  })});
  bulkStatus.textContent="Completed";
  fetchLogs();
}

async function sendManual(){
  const nums=manualNumbers.value.split("\n");
  await fetch("/send-manual-numbers",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({numbers:nums,message:manualMessage.value})});
  fetchLogs();
}

fetchLogs();
</script>
</body>
</html>
