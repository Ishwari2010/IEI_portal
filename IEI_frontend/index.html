<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IEI SMS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --primary:#1f3c88;
  --primary-dark:#162f6a;
  --bg:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}
*{box-sizing:border-box;font-family:Inter,system-ui;}
body{
  margin:0;min-height:100vh;background:var(--bg);
  padding:40px 16px;color:#1f2937;
}
.container{max-width:1200px;margin:auto;}
.header{text-align:center;color:white;margin-bottom:30px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
@media(max-width:900px){.grid{grid-template-columns:1fr;}}
.card{
  background:white;border-radius:16px;padding:24px;
  box-shadow:0 18px 35px rgba(0,0,0,.18);
}
h2{color:var(--primary);margin-bottom:6px;}
p{color:#6b7280;font-size:.85rem;margin-bottom:18px;}
label{
  display:block;font-size:.7rem;font-weight:700;
  margin-bottom:6px;letter-spacing:.04em;
}
input,select,textarea{
  width:100%;padding:10px 12px;border-radius:10px;
  border:1px solid #d1d5db;font-size:.9rem;
}
button{
  width:100%;padding:12px;border-radius:999px;
  border:none;background:var(--primary);
  color:white;font-weight:600;cursor:pointer;
}
button:hover{background:var(--primary-dark);}
.divider{height:1px;background:#e5e7eb;margin:20px 0;}
.status{margin-top:8px;font-size:.85rem;color:#0369a1;min-height:20px;}
.status.success{color:#059669;background:#d1fae5;padding:8px 12px;border-radius:8px;margin-top:12px;}
.status.error{color:#dc2626;background:#fee2e2;padding:8px 12px;border-radius:8px;margin-top:12px;}
.status.loading{color:#0369a1;background:#dbeafe;padding:8px 12px;border-radius:8px;margin-top:12px;}
button:disabled{opacity:0.6;cursor:not-allowed;}
.logs{
  margin-top:30px;background:white;border-radius:16px;
  padding:22px;box-shadow:0 18px 35px rgba(0,0,0,.18);
}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;}
th{background:#f9fafb;}
.tag{padding:4px 10px;border-radius:999px;background:#e0f2fe;color:#0369a1;font-size:.7rem;}
.tag.error{background:#fee2e2;color:#dc2626;}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h1>IEI SMS Management System</h1>
  <p>Password dispatch & bulk messaging platform</p>
</div>

<div class="grid">

<!-- USER -->
<div class="card">
  <h2>User – Request Password</h2>
  <p>Receive IEI portal password via SMS</p>

  <label>Membership Type</label>
  <select id="prefix">
    <option value="F-">F</option>
    <option value="M-">M</option>
    <option value="AM">AM</option>
    <option value="ST">ST</option>
    <option value="T-">T</option>
  </select>

  <label>Membership Number</label>
  <input id="number" maxlength="7" placeholder="7-digit number">

  <button id="sendSingleBtn" onclick="sendSingle()">Send Password</button>
  <div id="singleStatus" class="status"></div>
</div>

<!-- ADMIN -->
<div class="card">
  <h2>Admin – Upload Excel</h2>
  <p>Upload members for bulk SMS</p>

  <input type="file" id="excelFile" accept=".xls,.xlsx">
  <button onclick="uploadExcel()">Upload Excel</button>
  <div id="uploadStatus" class="status"></div>

  <div class="divider"></div>

  <h2 style="font-size:1rem">Bulk SMS Controls</h2>

  <label>Batch Size</label>
  <input id="batchSize" type="number" value="5">

  <label>Delay (ms)</label>
  <input id="delayMs" type="number" value="3000">

  <label>Start Index</label>
  <input id="startIndex" type="number" value="0">

  <label>Limit (optional)</label>
  <input id="limit" type="number" placeholder="All">

  <button onclick="startBulk()">Start Bulk SMS</button>
  <div id="bulkStatus" class="status">Idle</div>

  <div class="divider"></div>

  <div class="divider"></div>

<h2 style="font-size:1rem">Bulk SMS Message Template</h2>
<p>You can edit the message. Use placeholders: {name}, {membership_id} and {password}</p>

<textarea id="smsTemplate" rows="5" placeholder="Enter SMS template">
Dear {name},
Your IEI Login Credentials are as follows:

Membership ID: {membership_id}
Password: {password}

Regards,
IEI Administration
</textarea>


<button onclick="saveTemplate()">Save Template</button>
<div id="templateStatus" class="status"></div>

<div class="divider"></div>

  <h2 style="font-size:1rem">Manual SMS</h2>

  <label>Phone Numbers</label>
  <textarea id="manualNumbers" rows="4" placeholder="One number per line"></textarea>

  <label>Message</label>
  <textarea id="manualMessage" rows="3" placeholder="Enter SMS text"></textarea>

  <button id="sendManualBtn" onclick="sendManual()">Send Manual SMS</button>
  <div id="manualStatus" class="status"></div>
</div>

</div>

<!-- LOGS -->
<div class="logs">
  <h2>Sent Messages Report</h2>
  <div id="logs">No messages sent yet.</div>
</div>

</div>

<script>
async function fetchLogs() {
  const logs = document.getElementById("logs");

  const r = await fetch("/sent-logs");
  const d = await r.json();

  if (!d.length) {
    logs.innerHTML = "No messages sent yet.";
    return;
  }

  let h = `
    <table>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>DOB</th>
        <th>Phone</th>
        <th>Date & Time</th>
        <th>Status</th>
      </tr>
  `;

  d.forEach(x => {
    const statusClass =
      x.status === "sent"
        ? "tag"
        : x.status === "failed"
        ? "tag error"
        : "tag";

    const statusText =
      x.status === "sent"
        ? "✅ Sent"
        : x.status === "failed"
        ? "❌ Failed"
        : x.status || "Unknown";

    h += `
      <tr>
        <td>${x.membership_id}</td>
        <td>${x.name || "-"}</td>
        <td>${x.email || "-"}</td>
        <td>${x.dob || "N/A"}</td>
        <td>******${x.last4}</td>
        <td>${new Date(x.timestamp).toLocaleString()}</td>
        <td><span class="${statusClass}">${statusText}</span></td>
      </tr>
    `;
  });

  h += "</table>";
  logs.innerHTML = h;
}

async function sendSingle() {
  const membershipId = prefix.value + number.value;

  if (!/^\d{7}$/.test(number.value)) {
    singleStatus.className = "status error";
    singleStatus.textContent = "❌ Please enter a valid 7-digit membership number";
    return;
  }

  const btn = document.getElementById("sendSingleBtn");
  const statusDiv = document.getElementById("singleStatus");

  btn.disabled = true;
  btn.textContent = "Sending...";
  statusDiv.className = "status loading";
  statusDiv.textContent = "⏳ Sending SMS...";

  try {
    const response = await fetch("/send-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ membership_id: membershipId })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      statusDiv.className = "status success";
      statusDiv.innerHTML = `✅ <strong>Success!</strong> SMS sent to ${data.memberName || "member"} (Phone: ******${data.phone})<br>
        <small>Message ID: ${data.messageId || "N/A"}</small>`;
    } else {
      statusDiv.className = "status error";
      statusDiv.innerHTML = `❌ <strong>Failed:</strong> ${data.message || data.error || "Unknown error"}`;
    }
  } catch (error) {
    statusDiv.className = "status error";
    statusDiv.innerHTML = `❌ <strong>Error:</strong> ${error.message || "Network error"}`;
  } finally {
    btn.disabled = false;
    btn.textContent = "Send Password";
    fetchLogs();
  }
}

async function uploadExcel() {
  const file = excelFile.files[0];
  if (!file) {
    uploadStatus.textContent = "Please select a file";
    return;
  }

  const fd = new FormData();
  fd.append("file", file);

  const r = await fetch("/upload-excel", { method: "POST", body: fd });
  const d = await r.json();

  uploadStatus.textContent = `${d.message} (${d.totalMembers} members)`;
  fetchLogs();
}

async function startBulk() {
  const btn = document.querySelector("button[onclick='startBulk()']");
  const statusDiv = document.getElementById("bulkStatus");

  btn.disabled = true;
  statusDiv.className = "status loading";
  statusDiv.textContent = "⏳ Running...";

  try {
    const response = await fetch("/bulk-send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        batchSize: +batchSize.value,
        delayMs: +delayMs.value,
        start: +startIndex.value,
        limit: limit.value || undefined
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      statusDiv.className = "status success";
      statusDiv.innerHTML = `✅ Completed<br>
        Total: ${data.stats.total} |
        Successful: ${data.stats.successful} |
        Failed: ${data.stats.failed}`;
    } else {
      statusDiv.className = "status error";
      statusDiv.textContent = data.message || "Failed";
    }
  } catch (e) {
    statusDiv.className = "status error";
    statusDiv.textContent = "Network error";
  } finally {
    btn.disabled = false;
    fetchLogs();
  }
}

async function sendManual() {
  const nums = manualNumbers.value.split("\n").filter(n => n.trim());
  if (!nums.length || !manualMessage.value.trim()) return;

  const r = await fetch("/send-manual-numbers", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ numbers: nums, message: manualMessage.value })
  });

  await r.json();
  fetchLogs();
}

async function saveTemplate() {
  const templateText = smsTemplate.value.trim();
  const status = document.getElementById("templateStatus");

  if (
  !templateText.includes("{name}") ||
  !templateText.includes("{membership_id}") ||
  !templateText.includes("{password}")
) {
  status.className = "status error";
  status.textContent =
    "❌ Template must include {name}, {membership_id} and {password}";
  return;
}


  status.className = "status loading";
  status.textContent = "⏳ Updating message template...";

  try {
    const res = await fetch("/update-template", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ template: templateText })
    });

    const data = await res.json();

    if (res.ok && data.success) {
      status.className = "status success";
      status.textContent = "✔️ Message template updated successfully.";

      // auto-hide after 3 seconds (optional)
      setTimeout(() => {
        status.textContent = "";
        status.className = "status";
      }, 3000);
    } else {
      status.className = "status error";
      status.textContent = "❌ " + (data.message || "Failed to update template");
    }
  } catch (error) {
    status.className = "status error";
    status.textContent = "❌ Network error. Please try again.";
  }
}


fetchLogs();
</script>

</body>
</html>
